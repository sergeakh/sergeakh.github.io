import{p as J,g as M,z as N,y as V,e as _,h as W,d as X,u as q,i as e,x as w,o as F,f as S,k as A,c as m,b as l,l as G,j as d,X as Q,s as x,n as h,L as Y,m as Z,B as ee,w as te}from"./index-BcoJaDVQ.js";import{e as ae}from"./crypto-Cpa8lgv9.js";import{c as re,b as ne,a as se}from"./webauthn-BEGDcNQV.js";import{g as oe}from"./api-9q_jSmK4.js";var t=(n=>(n[n.Signup=0]="Signup",n[n.SignupError=1]="SignupError",n))(t||{}),ie=S('<p class="message svelte-apkzbu">signup</p> <!>',1),le=S('<p class="message svelte-apkzbu">error signup</p> <div class="buttonContainer svelte-apkzbu"><div class="buttonContainerItem svelte-apkzbu"><!></div></div>',1),ue=S('<div class="content svelte-apkzbu"><!></div>');function ve(n,P){J(P,!0);const{updateStackPages:U}=M(),{getAccount:B,initCloudAccount:z}=N(),{getAppHistory:K,back:D,closeDialogStack:E,deleteSearchParam:T}=V();let j=w(K),f=w(B),b=_(""),s=_(W(t.Signup));const{blockDialog:u,unBlockBackDialog:v}=X(),k=async()=>{d(s,t.Signup,!0);try{const a=await oe(),r=crypto.getRandomValues(new Uint8Array(32)),o=await re({challenge:a,clientKey:r}),c=await fetch("/api/signup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(c.status!==200){d(s,t.SignupError,!0);return}const i=await c.json(),p=e(f)===void 0,{encryptedClientKey:y}=await ae({clientKey:r,serverKey:new Uint8Array(ne(i.serverKey))});if(Q(),await z({encryptedClientKey:se(y)}),p)u(!1),E();else{u(!1);let g=new URLSearchParams(e(j).search).get("retPath")||"";g&&(d(b,g,!0),T("retPath")),D({to:e(b)}),U()}}catch{d(s,t.SignupError,!0)}};q(()=>{e(f)===null&&u(e(s)===t.Signup),v(e(s)!==t.Signup)}),F(()=>(e(f)===void 0&&(u(!0),v(!1)),k(),()=>{v(!1)}));var C=ue(),H=m(C);{var L=a=>{var r=ie(),o=x(h(r),2);Y(o,{}),l(a,r)},R=a=>{var r=Z(),o=h(r);{var c=i=>{var p=le(),y=x(h(p),2),g=m(y),$=m(g);ee($,{onClick:()=>k(),fullWidth:!0,children:(O,ce)=>{var I=te("try again");l(O,I)},$$slots:{default:!0}}),l(i,p)};A(o,i=>{e(s)===t.SignupError&&i(c)},!0)}l(a,r)};A(H,a=>{e(s)===t.Signup?a(L):a(R,!1)})}l(n,C),G()}export{ve as default};
