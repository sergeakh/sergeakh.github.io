import{p as te,d as ae,g as re,z as se,y as ne,u as oe,i as s,e as L,o as le,f as y,k as h,c as v,b as t,l as ie,s as w,j as i,B as N,w as T,C as ce,m as K,n as f,L as O}from"./index-VYzmJzTN.js";import{I as de}from"./Input-BZMBbnmx.js";import{g as ve,b as fe,c as z,d as ye,a as pe}from"./webauthn-Dy13XHj8.js";import{d as me}from"./crypto-Cpa8lgv9.js";var ue=y('<form><p class="message error svelte-1wrlvyn">Enter a name for a key</p> <div class="inputContainer svelte-1wrlvyn"><!></div> <div class="buttonContainer svelte-1wrlvyn"><!></div></form>'),ge=y('<p class="message svelte-1wrlvyn">Adding the access key</p>'),he=y('<p class="message svelte-1wrlvyn">Confirming</p>'),Ce=y('<p class="message error svelte-1wrlvyn">Something went wrong</p> <div class="buttonContainer svelte-1wrlvyn"><!></div>',1),_e=y('<p class="message svelte-1wrlvyn">Confirm this operation with another key</p> <div class="buttonContainer svelte-1wrlvyn"><!></div>',1),we=y('<div class="content svelte-1wrlvyn"><!></div>');function xe(F,H){te(H,!0);const{blockDialog:B}=ae(),{popStackPages:J}=re(),{getAccount:U}=se(),{back:q}=ne();let e=L("idle"),C="",A=null,k=L("");oe(()=>{B(s(e)==="confirmingAccessKey"||s(e)==="addingAccessKey")}),le(()=>()=>{B(!1)});const M=async a=>{a.preventDefault(),i(e,"addingAccessKey");try{C=await ve();const r=await fe(),n=U();if(!n||!n.encryptedClientKey)throw new Error("No account found");const p=await me({encryptedClientKey:z(n.encryptedClientKey),serverKey:z(r)});A=await ye({challenge:C,clientKey:p}),i(e,"confirmAccessKey")}catch{i(e,"error");return}},G=async()=>{i(e,"confirmingAccessKey");try{const a=await pe({challenge:C});if(!A)throw new Error("No credential data found");if(!(await fetch("/api/addCredential",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challenge:C,name:s(k)||`key ${Math.floor(Math.random()*1e3)}`,newCredential:A,confirmCredential:a.credentialData})})).ok)throw new Error("Failed to add access key");J(),q()}catch{i(e,"error");return}};var j=we(),Q=v(j);{var R=a=>{var r=ue(),n=w(v(r),2),p=v(n);de(p,{placeholder:"key name",get value(){return s(k)},set value(l){i(k,l,!0)}});var $=w(n,2),o=v($);N(o,{onClick:M,children:(l,b)=>{var m=T("Add key");t(l,m)},$$slots:{default:!0}}),ce("submit",r,M),t(a,r)},V=a=>{var r=K(),n=f(r);{var p=o=>{O(o,{children:(l,b)=>{var m=ge();t(l,m)},$$slots:{default:!0}})},$=o=>{var l=K(),b=f(l);{var m=c=>{O(c,{children:(_,I)=>{var x=he();t(_,x)},$$slots:{default:!0}})},W=c=>{var _=K(),I=f(_);{var x=d=>{var u=Ce(),P=w(f(u),2),S=v(P);N(S,{onClick:()=>{i(e,"idle")},children:(g,D)=>{var E=T("Try Again");t(g,E)},$$slots:{default:!0}}),t(d,u)},X=d=>{var u=K(),P=f(u);{var S=g=>{var D=_e(),E=w(f(D),2),Y=v(E);N(Y,{onClick:G,children:(Z,Ke)=>{var ee=T("Confirm");t(Z,ee)},$$slots:{default:!0}}),t(g,D)};h(P,g=>{s(e)==="confirmAccessKey"&&g(S)},!0)}t(d,u)};h(I,d=>{s(e)==="error"?d(x):d(X,!1)},!0)}t(c,_)};h(b,c=>{s(e)==="confirmingAccessKey"?c(m):c(W,!1)},!0)}t(o,l)};h(n,o=>{s(e)==="addingAccessKey"?o(p):o($,!1)},!0)}t(a,r)};h(Q,a=>{s(e)==="idle"?a(R):a(V,!1)})}t(F,j),ie()}export{xe as default};
