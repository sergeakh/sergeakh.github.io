import{p as te,d as ae,g as se,z as re,A as oe,u as ne,i as r,e as F,o as ie,f as p,k as h,c as v,b as t,l as ce,s as A,j as c,B as E,w as N,D as le,m as K,n as f,E as de,F as I,G as ve,L,x as fe}from"./index-CZzB_zyz.js";import{g as pe,a as ye}from"./api-C5JaEwh0.js";import{I as me}from"./Input-BmQCHwHc.js";var ue=p('<form><p class="message error svelte-ey4qps">Enter a name for a key</p> <div class="inputContainer svelte-ey4qps"><!></div> <div class="buttonContainer svelte-ey4qps"><!></div></form>'),ge=p('<p class="message svelte-ey4qps">Adding the access key</p>'),he=p('<p class="message svelte-ey4qps">Confirming</p>'),Ce=p('<p class="message error svelte-ey4qps">Something went wrong</p> <div class="buttonContainer svelte-ey4qps"><!></div>',1),_e=p('<p class="message svelte-ey4qps">Confirm this operation with another key</p> <div class="buttonContainer svelte-ey4qps"><!></div>',1),Ae=p('<div class="content svelte-ey4qps"><!></div>');function be(O,z){te(z,!0);const{blockDialog:T}=ae(),{popStackPages:G}=se(),{getAccount:H}=re(),{back:J}=oe();let e=F("idle"),C="",k=null,w=F("");ne(()=>{T(r(e)==="confirmingAccessKey"||r(e)==="addingAccessKey")}),ie(()=>()=>{T(!1)});const B=async a=>{a.preventDefault(),c(e,"addingAccessKey");try{C=await pe();const s=await ye(),o=H();if(!o||!o.encryptedClientKey)throw new Error("No account found");const y=await de({encryptedClientKey:I(o.encryptedClientKey),serverKey:I(s)});k=await ve({challenge:C,clientKey:y}),c(e,"confirmAccessKey")}catch{c(e,"error");return}},U=async()=>{c(e,"confirmingAccessKey");try{const a=await fe({challenge:C});if(!k)throw new Error("No credential data found");if(!(await fetch("/api/addCredential",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challenge:C,name:r(w)||`key ${Math.floor(Math.random()*1e3)}`,newCredential:k,confirmCredential:a.credentialData})})).ok)throw new Error("Failed to add access key");G(),J()}catch{c(e,"error");return}};var M=Ae(),Q=v(M);{var R=a=>{var s=ue(),o=A(v(s),2),y=v(o);me(y,{placeholder:"key name",get value(){return r(w)},set value(i){c(w,i,!0)}});var $=A(o,2),n=v($);E(n,{onClick:B,children:(i,b)=>{var m=N("Add key");t(i,m)},$$slots:{default:!0}}),le("submit",s,B),t(a,s)},V=a=>{var s=K(),o=f(s);{var y=n=>{L(n,{children:(i,b)=>{var m=ge();t(i,m)},$$slots:{default:!0}})},$=n=>{var i=K(),b=f(i);{var m=l=>{L(l,{children:(_,j)=>{var q=he();t(_,q)},$$slots:{default:!0}})},W=l=>{var _=K(),j=f(_);{var q=d=>{var u=Ce(),x=A(f(u),2),P=v(x);E(P,{onClick:()=>{c(e,"idle")},children:(g,S)=>{var D=N("Try Again");t(g,D)},$$slots:{default:!0}}),t(d,u)},X=d=>{var u=K(),x=f(u);{var P=g=>{var S=_e(),D=A(f(S),2),Y=v(D);E(Y,{onClick:U,children:(Z,Ke)=>{var ee=N("Confirm");t(Z,ee)},$$slots:{default:!0}}),t(g,S)};h(x,g=>{r(e)==="confirmAccessKey"&&g(P)},!0)}t(d,u)};h(j,d=>{r(e)==="error"?d(q):d(X,!1)},!0)}t(l,_)};h(b,l=>{r(e)==="confirmingAccessKey"?l(m):l(W,!1)},!0)}t(n,i)};h(o,n=>{r(e)==="addingAccessKey"?n(y):n($,!1)},!0)}t(a,s)};h(Q,a=>{r(e)==="idle"?a(R):a(V,!1)})}t(O,M),ce()}export{be as default};
