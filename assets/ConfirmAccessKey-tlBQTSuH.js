import{p as Y,g as Z,u as ee,h as s,d as G,o as ae,f,j as h,c as v,b as a,k as te,s as A,i as c,B as H,v as N,G as re,l as k,m as y,z as se,L as j,H as ne,J as oe}from"./index-BmNZNyoD.js";import{g as ie,b as ce,c as I,d as le,a as de}from"./webauthn-CIYiTW38.js";import{I as ve}from"./Input-DulaCt0D.js";const ye=async C=>{const b=await crypto.subtle.importKey("raw",C.serverKey,{name:"HKDF"},!1,["deriveKey"]),K=await crypto.subtle.deriveKey({name:"HKDF",info:new TextEncoder().encode("aes-gcm-shared"),hash:"SHA-256",salt:new Uint8Array(12)},b,{name:"AES-GCM",length:256},!1,["decrypt"]),e=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(12)},K,C.encryptedClientKey);return new Uint8Array(e)};var fe=f('<form><p class="message error svelte-ey4qps">Enter a name for a key</p> <div class="inputContainer svelte-ey4qps"><!></div> <div class="buttonContainer svelte-ey4qps"><!></div></form>'),pe=f('<p class="message svelte-ey4qps">Adding the access key</p>'),me=f('<p class="message svelte-ey4qps">Confirming</p>'),ue=f('<p class="message error svelte-ey4qps">Something went wrong</p> <div class="buttonContainer svelte-ey4qps"><!></div>',1),ge=f('<p class="message svelte-ey4qps">Confirm this operation with another key</p> <div class="buttonContainer svelte-ey4qps"><!></div>',1),he=f('<div class="content svelte-ey4qps"><!></div>');function Ae(C,b){Y(b,!0);const{blockDialog:K}=Z();let e=G("idle"),_="",$=null,q=G("");ee(()=>{K(s(e)==="confirmingAccessKey"||s(e)==="addingAccessKey")}),ae(()=>()=>{K(!1)});const U=async t=>{t.preventDefault(),c(e,"addingAccessKey");try{_=await ie();const r=await ce(),n=se();if(!n||!n.encryptedClientKey)throw new Error("No account found");const p=await ye({encryptedClientKey:I(n.encryptedClientKey),serverKey:I(r)});$=await le({challenge:_,clientKey:p}),c(e,"confirmAccessKey")}catch{c(e,"error");return}},J=async()=>{c(e,"confirmingAccessKey");try{const t=await de({challenge:_});if(!$)throw new Error("No credential data found");if(!(await fetch("/api/addCredential",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challenge:_,name:s(q)||`key ${Math.floor(Math.random()*1e3)}`,newCredential:$,confirmCredential:t.credentialData})})).ok)throw new Error("Failed to add access key");ne(),oe()}catch{c(e,"error");return}};var B=he(),L=v(B);{var O=t=>{var r=fe(),n=A(v(r),2),p=v(n);ve(p,{placeholder:"key name",get value(){return s(q)},set value(i){c(q,i,!0)}});var P=A(n,2),o=v(P);H(o,{onClick:U,children:(i,S)=>{var m=N("Add key");a(i,m)},$$slots:{default:!0}}),re("submit",r,U),a(t,r)},z=t=>{var r=k(),n=y(r);{var p=o=>{j(o,{children:(i,S)=>{var m=pe();a(i,m)},$$slots:{default:!0}})},P=o=>{var i=k(),S=y(i);{var m=l=>{j(l,{children:(w,F)=>{var x=me();a(w,x)},$$slots:{default:!0}})},Q=l=>{var w=k(),F=y(w);{var x=d=>{var u=ue(),D=A(y(u),2),E=v(D);H(E,{onClick:()=>{c(e,"idle")},children:(g,M)=>{var T=N("Try Again");a(g,T)},$$slots:{default:!0}}),a(d,u)},R=d=>{var u=k(),D=y(u);{var E=g=>{var M=ge(),T=A(y(M),2),V=v(T);H(V,{onClick:J,children:(W,Ce)=>{var X=N("Confirm");a(W,X)},$$slots:{default:!0}}),a(g,M)};h(D,g=>{s(e)==="confirmAccessKey"&&g(E)},!0)}a(d,u)};h(F,d=>{s(e)==="error"?d(x):d(R,!1)},!0)}a(l,w)};h(S,l=>{s(e)==="confirmingAccessKey"?l(m):l(Q,!1)},!0)}a(o,i)};h(n,o=>{s(e)==="addingAccessKey"?o(p):o(P,!1)},!0)}a(t,r)};h(L,t=>{s(e)==="idle"?t(O):t(z,!1)})}a(C,B),te()}export{Ae as default};
