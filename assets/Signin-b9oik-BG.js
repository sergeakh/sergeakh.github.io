import{p as z,y as F,z as J,g as M,d as N,e as w,h as W,u as q,i as n,x as G,o as Q,f as b,k as x,c as y,b as c,l as V,j as l,s as A,n as S,L as X,m as Y,B as Z,w as ee}from"./index-CtgUzf3X.js";import{e as te}from"./crypto-Cpa8lgv9.js";import{g as ae,a as ne,c as re,e as se}from"./webauthn-Dy13XHj8.js";var e=(r=>(r[r.Signin=0]="Signin",r[r.SigninError=1]="SigninError",r))(e||{}),ie=b('<p class="message svelte-bhmjvc">signin</p> <!>',1),oe=b('<p class="message svelte-bhmjvc">error signin</p> <div class="buttonContainer svelte-bhmjvc"><div class="buttonContainerItem svelte-bhmjvc"><!></div></div>',1),ce=b('<div class="content svelte-bhmjvc"><!></div>');function de(r,j){z(j,!0);const{getAppHistory:B,back:K,closeDialogStack:P,deleteSearchParam:E}=F(),{initCloudAccount:D,getAccount:U}=J(),{updateStackPages:T}=M(),H=B(),{blockDialog:g,unBlockBackDialog:f}=N();let p=G(U),C=w(""),a=w(W(e.Signin));const _=async()=>{l(a,e.Signin,!0);try{const t=await ae(),{credentialData:s,clientKey:o}=await ne({challenge:t}),u=await fetch("/api/signin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(u.status!==200){l(a,e.SigninError,!0);return}const i=await u.json();if(!i.serverKey){l(a,e.SigninError,!0);return}const v=i.serverKey,h=n(p)===void 0,{encryptedClientKey:m}=await te({clientKey:o,serverKey:new Uint8Array(re(v))});if(await D({encryptedClientKey:se(m)}),h)g(!1),P();else{g(!1);let d=new URLSearchParams(H.search).get("retPath")||"";d&&(l(C,d,!0),E("retPath")),K({to:n(C)}),T()}}catch{l(a,e.SigninError,!0)}};q(()=>{n(p)===null&&g(n(a)===e.Signin),f(n(a)!==e.Signin)}),Q(()=>(n(p)===void 0&&(g(!0),f(!1)),_(),()=>{f(!1)}));var k=ce(),I=y(k);{var L=t=>{var s=ie(),o=A(S(s),2);X(o,{}),c(t,s)},$=t=>{var s=Y(),o=S(s);{var u=i=>{var v=oe(),h=A(S(v),2),m=y(h),d=y(m);Z(d,{onClick:()=>_(),fullWidth:!0,children:(O,le)=>{var R=ee("try again");c(O,R)},$$slots:{default:!0}}),c(i,v)};x(o,i=>{n(a)===e.SigninError&&i(u)},!0)}c(t,s)};x(I,t=>{n(a)===e.Signin?t(L):t($,!1)})}c(r,k),V()}export{de as default};
