import{p as R,z,A as J,g as M,d as N,e as k,h as W,u as q,i as a,y as G,o as Q,f as y,k as A,c as m,b as c,l as V,j as l,x as X,F as Y,s as w,n as S,L as Z,m as ee,B as te,w as ne}from"./index-DGGsS_Lk.js";import{g as ae}from"./api-C5JaEwh0.js";var e=(r=>(r[r.Signin=0]="Signin",r[r.SigninError=1]="SigninError",r))(e||{}),re=y('<p class="message svelte-bhmjvc">signin</p> <!>',1),se=y('<p class="message svelte-bhmjvc">error signin</p> <div class="buttonContainer svelte-bhmjvc"><div class="buttonContainerItem svelte-bhmjvc"><!></div></div>',1),ie=y('<div class="content svelte-bhmjvc"><!></div>');function ge(r,x){R(x,!0);const{getAppHistory:j,back:P,closeDialogStack:E,deleteSearchParam:B}=z(),{initCloudAccount:D,getAccount:K}=J(),{updateStackPages:U}=M(),H=j(),{blockDialog:g,unBlockBackDialog:f}=N();let h=G(K),b=k(""),n=k(W(e.Signin));const _=async()=>{l(n,e.Signin,!0);try{const t=await ae(),{credentialData:s,clientKey:o}=await X({challenge:t}),v=await fetch("/api/signin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(v.status!==200){l(n,e.SigninError,!0);return}const i=await v.json();if(!i.serverKey){l(n,e.SigninError,!0);return}const u=i.serverKey,p=a(h)===void 0;if(await D({clientKey:o,serverKey:new Uint8Array(Y(u))}),p)g(!1),E();else{g(!1);let d=new URLSearchParams(H.search).get("retPath")||"";d&&(l(b,d,!0),B("retPath")),P({to:a(b)}),U()}}catch{l(n,e.SigninError,!0)}};q(()=>{a(h)===null&&g(a(n)===e.Signin),f(a(n)!==e.Signin)}),Q(()=>(a(h)===void 0&&(g(!0),f(!1)),_(),()=>{f(!1)}));var C=ie(),I=m(C);{var L=t=>{var s=re(),o=w(S(s),2);Z(o,{}),c(t,s)},T=t=>{var s=ee(),o=S(s);{var v=i=>{var u=se(),p=w(S(u),2),d=m(p),$=m(d);te($,{onClick:()=>_(),fullWidth:!0,children:(F,oe)=>{var O=ne("try again");c(F,O)},$$slots:{default:!0}}),c(i,u)};A(o,i=>{a(n)===e.SigninError&&i(v)},!0)}c(t,s)};A(I,t=>{a(n)===e.Signin?t(L):t(T,!1)})}c(r,C),V()}export{ge as default};
