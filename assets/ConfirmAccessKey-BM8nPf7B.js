import{p as te,d as ae,g as re,z as se,y as ne,u as oe,i as s,e as L,o as le,f as y,k as h,c as d,b as t,l as ie,s as w,j as i,B as N,w as T,C as ce,m as K,n as f,L as O}from"./index-BcoJaDVQ.js";import{b as z,c as ve,g as de}from"./webauthn-BEGDcNQV.js";import{g as fe,a as ye}from"./api-9q_jSmK4.js";import{d as me}from"./crypto-Cpa8lgv9.js";import{I as pe}from"./Input-BimZkEGw.js";var ue=y('<form><p class="message error svelte-1wrlvyn">Enter a name for a key</p> <div class="inputContainer svelte-1wrlvyn"><!></div> <div class="buttonContainer svelte-1wrlvyn"><!></div></form>'),ge=y('<p class="message svelte-1wrlvyn">Adding the access key</p>'),he=y('<p class="message svelte-1wrlvyn">Confirming</p>'),Ce=y('<p class="message error svelte-1wrlvyn">Something went wrong</p> <div class="buttonContainer svelte-1wrlvyn"><!></div>',1),_e=y('<p class="message svelte-1wrlvyn">Confirm this operation with another key</p> <div class="buttonContainer svelte-1wrlvyn"><!></div>',1),we=y('<div class="content svelte-1wrlvyn"><!></div>');function Pe(F,H){te(H,!0);const{blockDialog:B}=ae(),{popStackPages:J}=re(),{getAccount:U}=se(),{back:q}=ne();let e=L("idle"),C="",A=null,k=L("");oe(()=>{B(s(e)==="confirmingAccessKey"||s(e)==="addingAccessKey")}),le(()=>()=>{B(!1)});const M=async a=>{a.preventDefault(),i(e,"addingAccessKey");try{C=await fe();const r=await ye(),n=U();if(!n||!n.encryptedClientKey)throw new Error("No account found");const m=await me({encryptedClientKey:z(n.encryptedClientKey),serverKey:z(r)});A=await ve({challenge:C,clientKey:m}),i(e,"confirmAccessKey")}catch{i(e,"error");return}},G=async()=>{i(e,"confirmingAccessKey");try{const a=await de({challenge:C});if(!A)throw new Error("No credential data found");if(!(await fetch("/api/addCredential",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challenge:C,name:s(k)||`key ${Math.floor(Math.random()*1e3)}`,newCredential:A,confirmCredential:a.credentialData})})).ok)throw new Error("Failed to add access key");J(),q()}catch{i(e,"error");return}};var j=we(),Q=d(j);{var R=a=>{var r=ue(),n=w(d(r),2),m=d(n);pe(m,{placeholder:"key name",get value(){return s(k)},set value(l){i(k,l,!0)}});var $=w(n,2),o=d($);N(o,{onClick:M,children:(l,b)=>{var p=T("Add key");t(l,p)},$$slots:{default:!0}}),ce("submit",r,M),t(a,r)},V=a=>{var r=K(),n=f(r);{var m=o=>{O(o,{children:(l,b)=>{var p=ge();t(l,p)},$$slots:{default:!0}})},$=o=>{var l=K(),b=f(l);{var p=c=>{O(c,{children:(_,I)=>{var x=he();t(_,x)},$$slots:{default:!0}})},W=c=>{var _=K(),I=f(_);{var x=v=>{var u=Ce(),P=w(f(u),2),S=d(P);N(S,{onClick:()=>{i(e,"idle")},children:(g,D)=>{var E=T("Try Again");t(g,E)},$$slots:{default:!0}}),t(v,u)},X=v=>{var u=K(),P=f(u);{var S=g=>{var D=_e(),E=w(f(D),2),Y=d(E);N(Y,{onClick:G,children:(Z,Ke)=>{var ee=T("Confirm");t(Z,ee)},$$slots:{default:!0}}),t(g,D)};h(P,g=>{s(e)==="confirmAccessKey"&&g(S)},!0)}t(v,u)};h(I,v=>{s(e)==="error"?v(x):v(X,!1)},!0)}t(c,_)};h(b,c=>{s(e)==="confirmingAccessKey"?c(p):c(W,!1)},!0)}t(o,l)};h(n,o=>{s(e)==="addingAccessKey"?o(m):o($,!1)},!0)}t(a,r)};h(Q,a=>{s(e)==="idle"?a(R):a(V,!1)})}t(F,j),ie()}export{Pe as default};
