import{p as z,z as F,A as J,h as M,i as N,j as w,k as W,u as G,g as a,y as Q,o as V,f as _,m as x,c as m,d as o,n as X,l as v,U as Y,H as A,w as S,s as B,L as Z,q as ee,r as te,B as re}from"./BnHyY52N.js";import{g as ne,b as ae,a as ie}from"./BEGDcNQV.js";import{g as se}from"./9q_jSmK4.js";import{e as oe}from"./Cpa8lgv9.js";var e=(i=>(i[i.Signin=0]="Signin",i[i.SigninError=1]="SigninError",i))(e||{}),ce=_('<div class="container svelte-bhmjvc"><!> <!></div>'),le=_('<div class="container svelte-bhmjvc"><!> <!></div>'),ge=_('<div class="block svelte-bhmjvc"><!></div>');function pe(i,K){z(K,!0);const{getAppHistory:E,back:$,closeDialogStack:j,deleteSearchParam:D}=F(),{initCloudAccount:U,getAccount:H}=J(),{updateStackPages:T}=M(),L=E(),{blockDialog:f,unBlockBackDialog:C}=N();let p=Q(H),b=w(""),r=w(W(e.Signin));const k=async()=>{v(r,e.Signin,!0);try{const t=await se(),{credentialData:s,clientKey:c}=await ne({challenge:t}),l=await fetch("/api/signin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(l.status!==200){v(r,e.SigninError,!0);return}const n=await l.json();if(!n.serverKey){v(r,e.SigninError,!0);return}const u=n.serverKey,g=a(p)===void 0,{encryptedClientKey:h}=await oe({clientKey:c,serverKey:new Uint8Array(ae(u))});if(Y(),await U({encryptedClientKey:ie(h)}),g)f(!1),j();else{f(!1);let d=new URLSearchParams(L.search).get("retPath")||"";d&&(v(b,d,!0),D("retPath")),$({to:a(b)}),T()}}catch{v(r,e.SigninError,!0)}};G(()=>{a(p)===null&&f(a(r)===e.Signin),C(a(r)!==e.Signin)}),V(()=>{a(p)===void 0&&(f(!0),C(!1)),k()});var P=ge(),I=m(P);{var O=t=>{var s=ce(),c=m(s);A(c,{children:(n,u)=>{var g=S("signin");o(n,g)}});var l=B(c,2);Z(l,{}),o(t,s)},R=t=>{var s=ee(),c=te(s);{var l=n=>{var u=le(),g=m(u);A(g,{children:(d,q)=>{var y=S("error signin");o(d,y)}});var h=B(g,2);re(h,{onClick:()=>k(),fullWidth:!0,children:(d,q)=>{var y=S("try again");o(d,y)},$$slots:{default:!0}}),o(n,u)};x(c,n=>{a(r)===e.SigninError&&n(l)},!0)}o(t,s)};x(I,t=>{a(r)===e.Signin?t(O):t(R,!1)})}o(i,P),X()}export{pe as default};
