import{p as te,i as ae,h as re,A as se,z as ne,u as oe,g as s,j as L,o as le,f as p,m as C,c as y,d as e,n as ie,H as ce,w as K,s as k,l as i,B,D as de,q as $,r as m,L as O}from"./BV7DfawS.js";import{b as q,c as ve,g as fe}from"./BEGDcNQV.js";import{g as ye,a as me}from"./9q_jSmK4.js";import{d as pe}from"./Cpa8lgv9.js";import{I as ue}from"./BM6iwQlR.js";var ge=p('<form><!> <div class="inputContainer svelte-1wrlvyn"><!></div> <div class="buttonContainer svelte-1wrlvyn"><!></div></form>'),he=p('<p class="message svelte-1wrlvyn">Adding the access key</p>'),_e=p('<p class="message svelte-1wrlvyn">Confirming</p>'),Ce=p('<p class="message error svelte-1wrlvyn">Something went wrong</p> <div class="buttonContainer svelte-1wrlvyn"><!></div>',1),we=p('<p class="message svelte-1wrlvyn">Confirm this operation with another key</p> <div class="buttonContainer svelte-1wrlvyn"><!></div>',1),Ae=p('<div class="block svelte-1wrlvyn"><!></div>');function De(z,F){te(F,!0);const{blockDialog:H}=ae(),{popStackPages:J}=re(),{getAccount:U}=se(),{back:G}=ne();let t=L("idle"),w="",b=null,x=L("");oe(()=>{H(s(t)==="confirmingAccessKey"||s(t)==="addingAccessKey")}),le(()=>()=>{H(!1)});const M=async a=>{a.preventDefault(),i(t,"addingAccessKey");try{w=await ye();const r=await me(),n=U();if(!n||!n.encryptedClientKey)throw new Error("No account found");const c=await pe({encryptedClientKey:q(n.encryptedClientKey),serverKey:q(r)});b=await ve({challenge:w,clientKey:c}),i(t,"confirmAccessKey")}catch{i(t,"error");return}},Q=async()=>{i(t,"confirmingAccessKey");try{const a=await fe({challenge:w});if(!b)throw new Error("No credential data found");if(!(await fetch("/api/addCredential",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challenge:w,name:s(x)||`key ${Math.floor(Math.random()*1e3)}`,newCredential:b,confirmCredential:a.credentialData})})).ok)throw new Error("Failed to add access key");J(),G()}catch{i(t,"error");return}};var j=Ae(),R=y(j);{var V=a=>{var r=ge(),n=y(r);ce(n,{children:(l,u)=>{var g=K("Enter a name for a key");e(l,g)}});var c=k(n,2),P=y(c);ue(P,{placeholder:"key name",get value(){return s(x)},set value(l){i(x,l,!0)}});var o=k(c,2),d=y(o);B(d,{onClick:M,children:(l,u)=>{var g=K("Add key");e(l,g)},$$slots:{default:!0}}),de("submit",r,M),e(a,r)},W=a=>{var r=$(),n=m(r);{var c=o=>{O(o,{children:(d,l)=>{var u=he();e(d,u)},$$slots:{default:!0}})},P=o=>{var d=$(),l=m(d);{var u=v=>{O(v,{children:(A,I)=>{var D=_e();e(A,D)},$$slots:{default:!0}})},g=v=>{var A=$(),I=m(A);{var D=f=>{var h=Ce(),S=k(m(h),2),E=y(S);B(E,{onClick:()=>{i(t,"idle")},children:(_,N)=>{var T=K("Try Again");e(_,T)},$$slots:{default:!0}}),e(f,h)},X=f=>{var h=$(),S=m(h);{var E=_=>{var N=we(),T=k(m(N),2),Y=y(T);B(Y,{onClick:Q,children:(Z,Ke)=>{var ee=K("Confirm");e(Z,ee)},$$slots:{default:!0}}),e(_,N)};C(S,_=>{s(t)==="confirmAccessKey"&&_(E)},!0)}e(f,h)};C(I,f=>{s(t)==="error"?f(D):f(X,!1)},!0)}e(v,A)};C(l,v=>{s(t)==="confirmingAccessKey"?v(u):v(g,!1)},!0)}e(o,d)};C(n,o=>{s(t)==="addingAccessKey"?o(c):o(P,!1)},!0)}e(a,r)};C(R,a=>{s(t)==="idle"?a(V):a(W,!1)})}e(z,j),ie()}export{De as default};
