import{R as se,N as re,p as Me,w as Ne,v as Be,C as Fe,E as We,a as W,x as ue,K as ze,M as je,y as He,g as a,o as ne,s as o,f as x,i as u,b as g,e as i,h as Oe,j as L,d as m,S as me,z as te,c as _e,I as he,L as Je,r as Re,T as xe,B as X,A as G,u as we,t as Ke,n as Ue,q as Ve,J as ae}from"./aBhExeEdR.js";import"./aBsesnmW0.js";const ie=(w,l,d,n=new Set,c={},Q=Date.now())=>{for(let b=0;b<w.children.length;b++){const s=w.children[b];if(s.tagName==="DT"){const T=s.querySelector(":scope > A"),P=s.querySelector(":scope > H3");if(T){const k=T.getAttribute("href"),y=Number(T.getAttribute("add_date"))*1e3||Q+b,p=T.textContent||"unknown";if(!k)return d;const D=l.find(C=>C.toLowerCase()==="bookmarks bar")?l.filter(C=>C.toLowerCase()!=="bookmarks bar"):["other"];if(c[k])c[k].data.tags=[...new Set([...c[k].data.tags,...D])];else{const C={id:se(),data:{link:{url:k,title:p},versionId:se(),text:"",tags:D.length>0?D:[],updatedAt:y,createdAt:y,history:[]}};c[k]=C,d.push(C)}}else if(P){const k=P.textContent?.trim();if(k&&P.nextElementSibling?.tagName==="DL"){const y=[...l];y.push(k);const p=P.nextElementSibling;n.has(p)||(n.add(p),ie(p,y,d,n,c,Q+b))}}}else s.tagName!=="DL"&&s.children.length>0&&(n.has(s)||(n.add(s),ie(s,[...l],d,n,c,Q+b)))}return d},Xe=async w=>{const l=await w.text(),c=new DOMParser().parseFromString(l,"text/html").querySelector("DL");return c?ie(c,[],[]):[]};function Ge(w){const l=[];return ke(w,[],l),l}function ke(w,l,d){for(const n of w){if(!n.url){const c=[...l,n.title].filter(Boolean);n.children&&ke(n.children,c,d);continue}d.push({id:se(),data:{link:{url:n.url,title:n.title||"unknown"},versionId:se(),text:"",tags:l.length>0?[...l]:[],updatedAt:n.dateAdded||Date.now(),createdAt:n.dateAdded||Date.now(),history:[]}})}}const Qe=async()=>{const w=await re().bookmarks.getTree();return Ge(w).map(d=>(d.data.tags=d.data.tags.map(n=>{const c=n.trim();return c.toLocaleLowerCase()==="other bookmarks"?"other":c}).filter(n=>!(n===""||n.toLocaleLowerCase()==="bookmarks bar")),d))};var Ye=x(`<div class="b c p-1gxeqe6"><p>(browser bookmarks or a this app's file)</p></div>`),Ze=x('<div class="h p-1gxeqe6"><p class="i j p-1gxeqe6">Additional tags:</p> <!></div>'),et=x('<div class="k p-1gxeqe6"><!></div>'),tt=x('<!> <div class="e p-1gxeqe6"><div class="f p-1gxeqe6"><button class="g p-1gxeqe6"><svelte-css-wrapper style="display: contents"><!></svelte-css-wrapper><span>Settings</span></button></div> <!> <!></div>',1),at=x("<p>(browser bookmarks or a this app's file)</p>"),rt=x('<p class="i j p-1gxeqe6">Additional tags:</p> <div class="o p-1gxeqe6"><!></div>',1),st=x('<div class="p p-1gxeqe6"><!></div> <div role="button" tabindex="-1"><div tabindex="-1" class="q p-1gxeqe6"><p class="p-1gxeqe6">Drag and drop your file here</p> <p class="p-1gxeqe6">or</p></div></div>',1),ot=x('<div class="l p-1gxeqe6"><div class="m p-1gxeqe6"><!> <div class="f p-1gxeqe6"><button class="g n p-1gxeqe6"><svelte-css-wrapper style="display: contents"><!></svelte-css-wrapper><span>Settings</span></button></div> <!></div> <!></div>'),nt=x('<!> <!> <input type="file" accept=".txt, .html" style="display: none;"/>',1),it=x('<div class="b c p-1gxeqe6"><p class="i r p-1gxeqe6">Loading...</p> <!></div>'),lt=x('<div class="b c p-1gxeqe6"><p class="i s p-1gxeqe6">Something went wrong</p></div> <div class="t p-1gxeqe6"><!></div>',1),dt=x('<div class="b c p-1gxeqe6"><p class="i u p-1gxeqe6">Success!</p></div> <div class="t p-1gxeqe6"><!></div>',1),ct=x('<div class="a p-1gxeqe6"><!></div>');function ft(w,l){Me(l,!0);const{blockDialog:d}=Ne(),n=Be(),c=Fe(),Q=We();let b=W(ue("file")),s=W("idle"),T=W(null),P=W(!1),k=W(null),y=W(ue([])),p=W(!1),D=W(!1);const C=ze(),be=je(),ye=()=>{n.clear()};He(()=>{d(a(s)==="loading")}),ne(()=>(a(T)&&a(T).addEventListener("cancel",e=>{o(s,"idle"),e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation()}),()=>{d(!1)}));const qe=async e=>{const t=await e.text(),f=JSON.parse(t),z=[];if(!f.notes)throw new Error("Invalid import file format");for(const K of Object.values(f.notes))K&&z.push(K);return z},le=async e=>{o(s,"loading");let t=[];try{if(e.name.endsWith(".txt"))t=await qe(e);else if(e.name.endsWith(".html"))t=await Xe(e);else throw new Error("Unsupported file format. Please upload a TXT or HTML file.");await pe(t),o(s,"success")}catch{o(s,"error")}},Se=async e=>{const t=e.target;!t.files||t.files.length===0||await le(t.files[0])},de=()=>{a(T)?.click()},Te=e=>{e.preventDefault(),e.stopPropagation(),o(P,!0)},Pe=e=>{e.preventDefault(),e.stopPropagation(),o(P,!1)},De=e=>{e.preventDefault(),e.stopPropagation(),o(P,!0)},Ce=async e=>{if(e.preventDefault(),e.stopPropagation(),o(P,!1),!e.dataTransfer?.files||e.dataTransfer.files.length===0)return;const t=e.dataTransfer.files[0];if(t.type!=="application/json"&&t.type!=="text/html"){o(s,"error");return}await le(t)},ce=e=>{o(y,e,!0)},pe=async e=>{await Q.importNotes(e.map(t=>({...t,data:{...t.data,tags:Array.from(new Set([...t.data.tags||[],...a(y)])),history:(t.data.history||[]).map(f=>({...f,tags:Array.from(new Set([...f.tags||[],...a(y)]))}))}}))),await new Promise(t=>setTimeout(t,500))},ve=e=>{e.key==="Escape"&&(document.activeElement instanceof HTMLInputElement&&document.activeElement.type==="text"||document.activeElement instanceof HTMLTextAreaElement)&&(a(p)&&o(p,!1),document.activeElement.blur(),e.preventDefault(),e.stopPropagation())},Le=async()=>new Promise(e=>{re().permissions.contains({permissions:["bookmarks"],origins:["<all_urls>"]},t=>{t?e(!0):be.getViewMode()==="popup"?(re().runtime.sendMessage({type:"requestPermissions",data:{name:"importBookmarks",permissions:["bookmarks"],origins:["<all_urls>"],retpath:c.get().toString()}}),e(!1)):re().permissions.request({permissions:["bookmarks"],origins:["<all_urls>"]},f=>{e(!!f)})})}),ge=async()=>{if(o(s,"loading"),!await Le()){o(s,"idle");return}let t=[];try{t=await Qe(),await pe(t),o(s,"success")}catch{o(s,"error")}};ne(()=>(document.addEventListener("keydown",ve),()=>document.removeEventListener("keydown",ve))),ne(()=>{});var fe=ct(),Ee=g(fe);{var Ie=e=>{var t=nt(),f=L(t);u(f,_=>{});var z=m(f,2);{var K=_=>{var j=tt(),H=L(j);{var q=r=>{var v=Ye();i(r,v)};u(H,r=>{a(b)==="file"&&r(q)})}var E=m(H,2),I=g(E),A=g(I);A.__click=()=>{o(D,!a(D)),o(p,!1)};var S=g(A);_e(S,()=>({"--rotate":"30deg","--size":"20px"})),he(S.lastChild,{name:"settings"});var $=m(I,2);{var U=r=>{var v=Ze(),M=m(g(v),2);xe(M,{get selectedTags(){return a(y)},onChangeTags:ce,get shownTagInput(){return a(p)},set shownTagInput(J){o(p,J,!0)}}),i(r,v)};u($,r=>{a(D)&&r(U)})}var O=m($,2);{var Y=r=>{var v=et(),M=g(v);{var J=h=>{X(h,{fullWidth:!0,onClick:ge,children:(F,ee)=>{var R=G("Import");i(F,R)},$$slots:{default:!0}})},Z=h=>{X(h,{fullWidth:!0,onClick:de,children:(F,ee)=>{var R=G("Select file");i(F,R)},$$slots:{default:!0}})};u(M,h=>{a(b)==="browser"?h(J):h(Z,!1)})}i(r,v)};u(O,r=>{a(p)||r(Y)})}i(_,j)},N=_=>{var j=ot(),H=g(j),q=g(H);{var E=r=>{var v=at();i(r,v)};u(q,r=>{a(b)==="file"&&r(E)})}var I=m(q,2),A=g(I);A.__click=()=>{o(D,!a(D)),o(p,!1)};var S=g(A);_e(S,()=>({"--rotate":"30deg","--size":"20px"})),he(S.lastChild,{name:"settings"});var $=m(I,2);{var U=r=>{var v=rt(),M=m(L(v),2),J=g(M);xe(J,{get selectedTags(){return a(y)},onChangeTags:ce,get shownTagInput(){return a(p)},set shownTagInput(Z){o(p,Z,!0)}}),i(r,v)};u($,r=>{a(D)&&r(U)})}var O=m(H,2);{var Y=r=>{var v=te(),M=L(v);{var J=h=>{X(h,{fullWidth:!0,onClick:ge,children:(F,ee)=>{var R=G("Import");i(F,R)},$$slots:{default:!0}})},Z=h=>{var F=st(),ee=L(F),R=g(ee);X(R,{onClick:de,children:(oe,pt)=>{var $e=G("Select File");i(oe,$e)},$$slots:{default:!0}});var V=m(ee,2);me(V,oe=>o(k,oe),()=>a(k)),Ke(()=>Ue(V,1,Ve({v:!0,w:a(P)}),"p-1gxeqe6")),ae("dragenter",V,Te),ae("dragover",V,De),ae("dragleave",V,Pe),ae("drop",V,Ce),i(h,F)};u(M,h=>{a(b)==="browser"?h(J):h(Z,!1)})}i(r,v)};u(O,r=>{a(p)||r(Y)})}i(_,j)};u(z,_=>{C.check()?_(K):_(N,!1)})}var B=m(z,2);B.__change=Se,me(B,_=>o(T,_),()=>a(T)),i(e,t)},Ae=e=>{var t=te(),f=L(t);{var z=N=>{var B=it(),_=m(g(B),2);Je(_,{}),i(N,B)},K=N=>{var B=te(),_=L(B);{var j=q=>{var E=lt(),I=m(L(E),2),A=g(I);{let S=we(()=>C.check());X(A,{get fullWidth(){return a(S)},onClick:()=>{o(s,"idle")},children:($,U)=>{var O=G("Try Again");i($,O)},$$slots:{default:!0}})}i(q,E)},H=q=>{var E=te(),I=L(E);{var A=S=>{var $=dt(),U=m(L($),2),O=g(U);{let Y=we(()=>C.check());X(O,{get fullWidth(){return a(Y)},onClick:ye,children:(r,v)=>{var M=G("Close");i(r,M)},$$slots:{default:!0}})}i(S,$)};u(I,S=>{a(s)==="success"&&S(A)},!0)}i(q,E)};u(_,q=>{a(s)==="error"?q(j):q(H,!1)},!0)}i(N,B)};u(f,N=>{a(s)==="loading"?N(z):N(K,!1)},!0)}i(e,t)};u(Ee,e=>{a(s)==="idle"?e(Ie):e(Ae,!1)})}i(w,fe),Oe()}Re(["click","change"]);export{ft as default};
