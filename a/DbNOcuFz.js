import{p as q,z,A as F,h as J,i as M,j as A,k as N,u as W,g as a,y as G,o as Q,f as b,m as w,c as y,d as c,n as V,l,T as X,s as x,r as S,L as Y,q as Z,B as ee,x as te}from"./Bfj6ItVn.js";import{g as ne,b as ae,a as re}from"./BEGDcNQV.js";import{g as se}from"./9q_jSmK4.js";import{e as ie}from"./Cpa8lgv9.js";var e=(r=>(r[r.Signin=0]="Signin",r[r.SigninError=1]="SigninError",r))(e||{}),oe=b('<p class="message svelte-bhmjvc">signin</p> <!>',1),ce=b('<p class="message svelte-bhmjvc">error signin</p> <div class="buttonContainer svelte-bhmjvc"><div class="buttonContainerItem svelte-bhmjvc"><!></div></div>',1),le=b('<div class="content svelte-bhmjvc"><!></div>');function pe(r,P){q(P,!0);const{getAppHistory:j,back:B,closeDialogStack:K,deleteSearchParam:E}=z(),{initCloudAccount:D,getAccount:T}=F(),{updateStackPages:U}=J(),H=j(),{blockDialog:g,unBlockBackDialog:f}=M();let p=G(T),C=A(""),n=A(N(e.Signin));const _=async()=>{l(n,e.Signin,!0);try{const t=await se(),{credentialData:s,clientKey:o}=await ne({challenge:t}),u=await fetch("/api/signin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(u.status!==200){l(n,e.SigninError,!0);return}const i=await u.json();if(!i.serverKey){l(n,e.SigninError,!0);return}const v=i.serverKey,h=a(p)===void 0,{encryptedClientKey:m}=await ie({clientKey:o,serverKey:new Uint8Array(ae(v))});if(X(),await D({encryptedClientKey:re(m)}),h)g(!1),K();else{g(!1);let d=new URLSearchParams(H.search).get("retPath")||"";d&&(l(C,d,!0),E("retPath")),B({to:a(C)}),U()}}catch{l(n,e.SigninError,!0)}};W(()=>{a(p)===null&&g(a(n)===e.Signin),f(a(n)!==e.Signin)}),Q(()=>(a(p)===void 0&&(g(!0),f(!1)),_(),()=>{f(!1)}));var k=le(),I=y(k);{var L=t=>{var s=oe(),o=x(S(s),2);Y(o,{}),c(t,s)},$=t=>{var s=Z(),o=S(s);{var u=i=>{var v=ce(),h=x(S(v),2),m=y(h),d=y(m);ee(d,{onClick:()=>_(),fullWidth:!0,children:(O,ge)=>{var R=te("try again");c(O,R)},$$slots:{default:!0}}),c(i,v)};w(o,i=>{a(n)===e.SigninError&&i(u)},!0)}c(t,s)};w(I,t=>{a(n)===e.Signin?t(L):t($,!1)})}c(r,k),V()}export{pe as default};
