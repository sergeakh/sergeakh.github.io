import{p as z,z as F,A as J,n as M,q as N,h as b,r as R,u as W,g as d,o as G,f as m,i as x,c as p,d as s,j as Q,k as u,y as w,T as V,H as A,x as y,s as k,L as X,v as Y,l as Z,B as ee}from"./azEt-TEv_.js";import{g as te,b as re,a as ae}from"./abA9hIFUQ.js";import{g as ne}from"./a9q_jSmK4.js";import{e as ie}from"./aCpa8lgv9.js";var t=(a=>(a[a.Signin=0]="Signin",a[a.SigninError=1]="SigninError",a))(t||{}),se=m('<div class="container svelte-bhmjvc"><!> <!></div>'),oe=m('<div class="container svelte-bhmjvc"><!> <!></div>'),ce=m('<div class="block svelte-bhmjvc"><!></div>');function ue(a,K){z(K,!0);const{getAppLocation:E,back:$,deleteSearchParam:j}=F(),{initCloudAccount:B,getAccount:T}=J(),{clearStackPages:D}=M(),U=w(()=>E().searchParams),{blockDialog:S}=N();let H=w(T),_=b(""),n=b(R(t.Signin));const P=async()=>{u(n,t.Signin,!0),await new Promise(e=>setTimeout(e,2e3));try{const e=await ne(),{credentialData:i,clientKey:o}=await te({challenge:e}),c=await fetch("/api/signin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(c.status!==200){u(n,t.SigninError,!0);return}const r=await c.json();if(!r.serverKey){u(n,t.SigninError,!0);return}const v=r.serverKey,l=d(H)===void 0,{encryptedClientKey:f}=await ie({clientKey:o,serverKey:new Uint8Array(re(v))});if(V(),await B({encryptedClientKey:ae(f)}),S(!1),l)D();else{let g=d(U).get("retPath")||"";g&&(u(_,g,!0),j("retPath")),$({to:d(_)})}}catch(e){console.error("Error during sign-in:",e),u(n,t.SigninError,!0)}};W(()=>{S(d(n)===t.Signin)}),G(()=>{P()});var C=ce(),L=p(C);{var I=e=>{var i=se(),o=p(i);A(o,{children:(r,v)=>{var l=y("signin");s(r,l)}});var c=k(o,2);X(c,{}),s(e,i)},O=e=>{var i=Y(),o=Z(i);{var c=r=>{var v=oe(),l=p(v);A(l,{children:(g,q)=>{var h=y("error signin");s(g,h)}});var f=k(l,2);ee(f,{onClick:()=>P(),fullWidth:!0,children:(g,q)=>{var h=y("try again");s(g,h)},$$slots:{default:!0}}),s(r,v)};x(o,r=>{d(n)===t.SigninError&&r(c)},!0)}s(e,i)};x(L,e=>{d(n)===t.Signin?e(I):e(O,!1)})}s(a,C),Q()}export{ue as default};
