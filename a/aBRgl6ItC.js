import{p as K,J as M,u as Q,C as T,b as u,w as W,x,g as t,A as S,_ as J,a,$ as X,y as O,n as _,j as $,i as k,m as Y,a0 as C,f as Z,s as tt,c as et,B as at,z as it,a1 as nt}from"./aBBgiPFjy.js";var st=Z('<div class="a p-1hq9a8m"><p class="p-1hq9a8m">Note not found</p> <!></div>');function dt(w,h){K(h,!0);const{getNoteById:N,isInitedNotes:A,saveNote:P,updateNote:I,revertNote:b,pinNote:B}=M(),{clearDialogPages:D}=Q(),{getHref:q}=T();let l=u("idle"),s=u(""),f=u(void 0),n=u(void 0),r=u(""),d=u(W([])),g=u(!1),p=u(0);const v=S(A);x(()=>{t(v)&&(t(g),J(()=>{N(t(s))?.data.pinned!==t(g)&&B(t(s),t(g))}))}),x(()=>{t(v)&&J(()=>{const e=new URLSearchParams(h.params).get("id");if(e){a(s,e,!0);const i=N(t(s));i?.data&&(a(n,i.data.link?X(i.data.link):void 0,!0),a(r,i.data.text,!0),a(d,i.data.tags.slice(),!0),a(g,!!i.data.pinned,!0),a(p,i.data.updatedAt,!0))}})});const V=async()=>{if(t(f)){const e=N(t(s));if(!e?.data)return;const i=e.data.history?.find?.(y=>y.id===t(f));if(!i){a(f,void 0);return}if(i.link?.url===t(n)?.url&&i.link?.title===t(n)?.title&&i.text===t(r)&&JSON.stringify(i.tags)===JSON.stringify(t(d))){if(t(l)==="idle"){a(l,"loading");try{await b(t(s),t(f)),a(f,void 0),a(p,i.updatedAt,!0)}finally{a(l,"idle")}}}else if((e.data.link?.url!==t(n)?.url||e.data.link?.title!==t(n)?.title||e.data.text!==t(r)||JSON.stringify(e.data.tags)!==JSON.stringify(t(d)))&&(console.log(`savedNote.data.link?.url: ${e.data.link?.url} link?.url: ${t(n)?.url}`,e.data.link?.url!==t(n)?.url),console.log(`savedNote.data.link?.title: ${e.data.link?.title} link?.title: ${t(n)?.title}`,e.data.link?.title!==t(n)?.title),console.log(`savedNote.data.text: ${e.data.text} text: ${t(r)}`,e.data.text!==t(r)),console.log(`JSON.stringify(savedNote.data.tags): ${JSON.stringify(e.data.tags)} JSON.stringify(tags): ${JSON.stringify(t(d))}`,JSON.stringify(e.data.tags)!==JSON.stringify(t(d))),t(l)==="idle")){a(l,"loading");try{await I(t(s),{link:C(t(n)),text:t(r),tags:t(d).slice()})}finally{a(l,"idle")}}}else{const e=N(t(s));if(!e?.data)return;if((e.data.link?.url!==t(n)?.url||e.data.link?.title!==t(n)?.title||e.data.text!==t(r)||JSON.stringify(e.data.tags)!==JSON.stringify(t(d)))&&t(l)==="idle"){a(l,"loading");try{a(p,0),a(f,await P(t(s),{link:C(t(n)),text:t(r),tags:t(d).slice()}),!0)}finally{a(l,"idle")}}}};x(()=>{t(v)&&t(l)!=="loading"&&(console.log("Changes detected, handling change..."),V())});const j=e=>{e.preventDefault(),D()};var m=O(),z=_(m);{var F=e=>{var i=O(),y=_(i);{var H=c=>{var o=st(),R=tt(et(o),2);{let U=S(()=>q(""));at(R,{element:"a",get href(){return t(U)},onClick:j,children:(E,lt)=>{var G=it("close");k(E,G)},$$slots:{default:!0}})}k(c,o)},L=c=>{nt(c,{mode:"edit",get updatedAt(){return t(p)},get link(){return t(n)},set link(o){a(n,o,!0)},get text(){return t(r)},set text(o){a(r,o,!0)},get tags(){return t(d)},set tags(o){a(d,o,!0)},get pinned(){return t(g)},set pinned(o){a(g,o,!0)}})};$(y,c=>{!t(s)||!N(t(s))?c(H):c(L,!1)})}k(e,i)};$(z,e=>{t(v)&&e(F)})}k(w,m),Y()}export{dt as default};
