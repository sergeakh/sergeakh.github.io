import{p as F,z as J,A as M,h as N,i as R,j as x,k as W,u as G,g as r,y as A,o as Q,f as _,m as w,c as m,d as o,n as V,l as u,T as X,H as B,w as S,s as K,L as Y,q as Z,r as ee,B as te}from"./BLsQr5Kx.js";import{g as re,b as ne,a as ae}from"./BEGDcNQV.js";import{g as ie}from"./9q_jSmK4.js";import{e as se}from"./Cpa8lgv9.js";var e=(i=>(i[i.Signin=0]="Signin",i[i.SigninError=1]="SigninError",i))(e||{}),oe=_('<div class="container svelte-bhmjvc"><!> <!></div>'),ce=_('<div class="container svelte-bhmjvc"><!> <!></div>'),le=_('<div class="block svelte-bhmjvc"><!></div>');function fe(i,E){F(E,!0);const{getAppLocation:$,back:j,deleteSearchParam:D}=J(),{initCloudAccount:T,getAccount:U}=M(),{clearStackPages:H}=N(),L=A(()=>$().searchParams),{blockDialog:f,unBlockBackDialog:C}=R();let h=A(U),P=x(""),n=x(W(e.Signin));const b=async()=>{u(n,e.Signin,!0);try{const t=await ie(),{credentialData:s,clientKey:c}=await re({challenge:t}),l=await fetch("/api/signin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(l.status!==200){u(n,e.SigninError,!0);return}const a=await l.json();if(!a.serverKey){u(n,e.SigninError,!0);return}const v=a.serverKey,g=r(h)===void 0,{encryptedClientKey:p}=await se({clientKey:c,serverKey:new Uint8Array(ne(v))});if(X(),await T({encryptedClientKey:ae(p)}),g)f(!1),H();else{f(!1);let d=r(L).get("retPath")||"";d&&(u(P,d,!0),D("retPath")),j({to:r(P)})}}catch{u(n,e.SigninError,!0)}};G(()=>{r(h)===null&&f(r(n)===e.Signin),C(r(n)!==e.Signin)}),Q(()=>{r(h)===void 0&&(f(!0),C(!1)),b()});var k=le(),I=m(k);{var O=t=>{var s=oe(),c=m(s);B(c,{children:(a,v)=>{var g=S("signin");o(a,g)}});var l=K(c,2);Y(l,{}),o(t,s)},q=t=>{var s=Z(),c=ee(s);{var l=a=>{var v=ce(),g=m(v);B(g,{children:(d,z)=>{var y=S("error signin");o(d,y)}});var p=K(g,2);te(p,{onClick:()=>b(),fullWidth:!0,children:(d,z)=>{var y=S("try again");o(d,y)},$$slots:{default:!0}}),o(a,v)};w(c,a=>{r(n)===e.SigninError&&a(l)},!0)}o(t,s)};w(I,t=>{r(n)===e.Signin?t(O):t(q,!1)})}o(i,k),V()}export{fe as default};
