import{p as nt,E as rt,v as st,C as it,a as l,x as U,y as S,g as t,u as p,a1 as B,s as a,a2 as s,o as dt,z as $,j as b,i as L,e as C,h as lt,f as ot,d as ut,b as gt,B as ft,A as ct,a3 as pt}from"./aBhExeEdR.js";var ht=ot('<div class="a p-1hq9a8m"><p class="p-1hq9a8m">Note not found</p> <!></div>');function vt(M,T){nt(T,!0);const o=rt(),q=st(),{getHref:z}=it();let y=l("idle"),d=l(""),u=l(void 0),g=l(""),f=l(U([])),k=l(!1),A=l(0),c=l(void 0),I=l(void 0),r=l(-1),n=l(U([])),h=l("unknown");const P=p(()=>o.isInitedNotes());let v=l(null);S(()=>{if(!t(P))return;const e=new URLSearchParams(T.params).get("id");!e||e===t(d)||B(()=>{a(d,e,!0);const i=o.getNoteById(t(d));i?.data&&(a(u,i.data.link?s(i.data.link):void 0,!0),a(g,i.data.text,!0),a(f,i.data.tags.slice(),!0),a(k,!!i.data.pinned,!0),a(A,i.data.updatedAt,!0),a(n,s(i.data.history??[]),!0),a(c,{versionId:i.data.versionId,link:i.data.link?s(i.data.link):void 0,text:i.data.text,tags:i.data.tags.slice(),updatedAt:i.data.updatedAt},!0),t(n).push(s(t(c))),a(r,t(n).length-1))})});const j=async e=>{a(y,"loading");try{t(I)?t(c)?.link?.url===e.link?.url&&t(c)?.link?.title===e.link?.title&&t(c)?.text===e.text&&JSON.stringify(t(c)?.tags)===JSON.stringify(e.tags)?(await o.revertNote(t(d),t(c).versionId),a(I,void 0)):await o.updateNote(t(d),{link:s(e.link),text:e.text,tags:e.tags.slice()}):(a(A,0),a(I,await o.saveNote(t(d),{link:s(e.link),text:e.text,tags:e.tags.slice()}),!0))}finally{a(y,"idle")}},E=e=>{e.preventDefault(),q.clear()};let G=p(()=>t(r)>0),R=p(()=>t(r)<t(n).length-1);const V=()=>{if(t(r)<=0)return;a(r,t(r)-1);const e=t(n)[t(r)];a(u,s(e.link),!0),a(g,e.text,!0),a(f,s(e.tags),!0),a(h,"unknown"),N()},F=()=>{if(t(r)>=t(n).length-1)return;a(r,t(r)+1);const e=t(n)[t(r)];a(u,s(e.link),!0),a(g,e.text,!0),a(f,s(e.tags),!0),a(h,"unknown"),N()},K=e=>{a(k,e,!0),t(d)&&o.pinNote(t(d),e)},N=()=>{a(v,{link:s(t(u)),text:t(g),tags:t(f).slice()},!0)},w=e=>{a(u,e,!0),a(n,t(n).slice(0,t(r)+1),!0),a(h,"unknown"),t(n).push({versionId:void 0,link:s(t(u)),text:t(g),tags:s(t(f)),updatedAt:Date.now()}),a(r,t(n).length-1),N()},H=e=>{a(f,e,!0),a(n,t(n).slice(0,t(r)+1),!0),a(h,"unknown"),t(n).push({versionId:void 0,link:s(t(u)),text:t(g),tags:s(t(f)),updatedAt:Date.now()}),a(r,t(n).length-1),N()},J=e=>{a(g,e,!0),a(n,t(n).slice(0,t(r)+1),!0),t(h)!=="text"?(t(n).push({versionId:void 0,link:s(t(u)),text:t(g),tags:s(t(f)),updatedAt:Date.now()}),a(r,t(n).length-1)):(t(n)[t(r)].text=t(g),t(n)[t(r)].updatedAt=Date.now()),a(h,"text"),N()};S(()=>{t(y)!=="loading"&&t(v)&&B(()=>{t(v)&&(j(t(v)),a(v,null))})});let Q=p(()=>o.getGetNotesMap());S(()=>{if(!t(P)||t(y)==="loading"||!t(d))return;const e=t(Q)().get(t(d));B(()=>{e?.data&&(e.data.pinned!==t(k)&&a(k,!!e.data.pinned),e.data.text!==t(g)&&J(e.data.text),(e.data.link?.url!==t(u)?.url||e.data.link?.title!==t(u)?.title)&&w(s(e.data.link)),JSON.stringify(e.data.tags)!==JSON.stringify(t(f))&&H(s(e.data.tags)))})}),dt(()=>()=>{o.zipNoteHistory(t(d))});var O=$(),W=b(O);{var X=e=>{var i=$(),Y=b(i);{var Z=x=>{var m=ht(),_=ut(gt(m),2);{let tt=p(()=>z(""));ft(_,{element:"a",get href(){return t(tt)},onClick:E,children:(et,xt)=>{var at=ct("close");C(et,at)},$$slots:{default:!0}})}C(x,m)},D=x=>{{let m=p(()=>o.getNoteById(t(d))?.data.deletedAt),_=p(()=>o.getNoteById(t(d))?.data.archivedAt);pt(x,{get noteId(){return t(d)},mode:"edit",get link(){return t(u)},onChangeLink:w,get text(){return t(g)},onChangeText:J,get tags(){return t(f)},onChangeTags:H,get updatedAt(){return t(A)},get deletedAt(){return t(m)},get archivedAt(){return t(_)},get pinned(){return t(k)},onPinnedChange:K,get canNext(){return t(R)},get canPrev(){return t(G)},onNext:F,onPrev:V})}};L(Y,x=>{!t(d)||!o.getNoteById(t(d))?x(Z):x(D,!1)})}C(e,i)};L(W,e=>{t(P)&&e(X)})}C(M,O),lt()}export{vt as default};
