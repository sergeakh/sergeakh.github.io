import{p as ee,q as ae,A as re,n as te,u as se,g as s,h as L,o as ne,f as p,i as C,c as y,d as e,j as oe,H as le,x as A,s as $,k as i,B,E as ie,v as k,l as m,L as O}from"./aC1xpSvD-.js";import{b as q,c as ce,g as de}from"./abA9hIFUQ.js";import{g as ve,a as fe}from"./a9q_jSmK4.js";import{d as ye}from"./aCpa8lgv9.js";import{I as me}from"./aDq3vB9Uh.js";var pe=p('<form><!> <div class="inputContainer svelte-1wrlvyn"><!></div> <div class="buttonContainer svelte-1wrlvyn"><!></div></form>'),ue=p('<p class="message svelte-1wrlvyn">Adding the access key</p>'),ge=p('<p class="message svelte-1wrlvyn">Confirming</p>'),he=p('<p class="message error svelte-1wrlvyn">Something went wrong</p> <div class="buttonContainer svelte-1wrlvyn"><!></div>',1),_e=p('<p class="message svelte-1wrlvyn">Confirm this operation with another key</p> <div class="buttonContainer svelte-1wrlvyn"><!></div>',1),Ce=p('<div class="block svelte-1wrlvyn"><!></div>');function xe(F,J){ee(J,!0);const{blockDialog:M}=ae(),{getAccount:U}=re(),{popDialogPage:z}=te();let a=L("idle"),w="",b=null,x=L("");se(()=>{M(s(a)==="confirmingAccessKey"||s(a)==="addingAccessKey")}),ne(()=>()=>{M(!1)});const j=async r=>{r.preventDefault(),i(a,"addingAccessKey");try{w=await ve();const t=await fe(),n=U();if(!n||!n.encryptedClientKey)throw new Error("No account found");const c=await ye({encryptedClientKey:q(n.encryptedClientKey),serverKey:q(t)});b=await ce({challenge:w,clientKey:c}),i(a,"confirmAccessKey")}catch{i(a,"error");return}},G=async()=>{i(a,"confirmingAccessKey");try{const r=await de({challenge:w});if(!b)throw new Error("No credential data found");if(!(await fetch("/api/addCredential",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({challenge:w,name:s(x)||`key ${Math.floor(Math.random()*1e3)}`,newCredential:b,confirmCredential:r.credentialData})})).ok)throw new Error("Failed to add access key");z()}catch{i(a,"error");return}};var H=Ce(),Q=y(H);{var R=r=>{var t=pe(),n=y(t);le(n,{children:(l,u)=>{var g=A("Enter a name for a key");e(l,g)}});var c=$(n,2),P=y(c);me(P,{placeholder:"key name",get value(){return s(x)},set value(l){i(x,l,!0)}});var o=$(c,2),d=y(o);B(d,{onClick:j,children:(l,u)=>{var g=A("Add key");e(l,g)},$$slots:{default:!0}}),ie("submit",t,j),e(r,t)},V=r=>{var t=k(),n=m(t);{var c=o=>{O(o,{children:(d,l)=>{var u=ue();e(d,u)},$$slots:{default:!0}})},P=o=>{var d=k(),l=m(d);{var u=v=>{O(v,{children:(K,I)=>{var D=ge();e(K,D)},$$slots:{default:!0}})},g=v=>{var K=k(),I=m(K);{var D=f=>{var h=he(),E=$(m(h),2),N=y(E);B(N,{onClick:()=>{i(a,"idle")},children:(_,S)=>{var T=A("Try Again");e(_,T)},$$slots:{default:!0}}),e(f,h)},W=f=>{var h=k(),E=m(h);{var N=_=>{var S=_e(),T=$(m(S),2),X=y(T);B(X,{onClick:G,children:(Y,we)=>{var Z=A("Confirm");e(Y,Z)},$$slots:{default:!0}}),e(_,S)};C(E,_=>{s(a)==="confirmAccessKey"&&_(N)},!0)}e(f,h)};C(I,f=>{s(a)==="error"?f(D):f(W,!1)},!0)}e(v,K)};C(l,v=>{s(a)==="confirmingAccessKey"?v(u):v(g,!1)},!0)}e(o,d)};C(n,o=>{s(a)==="addingAccessKey"?o(c):o(P,!1)},!0)}e(r,t)};C(Q,r=>{s(a)==="idle"?r(R):r(V,!1)})}e(F,H),oe()}export{xe as default};
