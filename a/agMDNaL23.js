function i(t){const e=String.fromCharCode(...new Uint8Array(t));return window.btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function o(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");const n=e.length%4;return n&&(e+="=".repeat(4-n)),e}function s(t){try{const e=atob(t),n=new Uint8Array(e.length);for(let a=0;a<e.length;a++)n[a]=e.charCodeAt(a);return n.buffer}catch(e){throw e}}function y(t){const e=o(t);return s(e)}const d=async t=>{const e=await crypto.subtle.importKey("raw",t.serverKey,{name:"HKDF"},!1,["deriveKey"]),n=await crypto.subtle.deriveKey({name:"HKDF",salt:new Uint8Array(12),info:new TextEncoder().encode("aes-gcm-shared"),hash:"SHA-256"},e,{name:"AES-GCM",length:256},!1,["encrypt"]);return{encryptedClientKey:await crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(12)},n,t.clientKey)}},u=async t=>{const e=await crypto.subtle.importKey("raw",t.serverKey,{name:"HKDF"},!1,["deriveKey"]),n=await crypto.subtle.deriveKey({name:"HKDF",info:new TextEncoder().encode("aes-gcm-shared"),hash:"SHA-256",salt:new Uint8Array(12)},e,{name:"AES-GCM",length:256},!1,["decrypt"]),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(12)},n,t.encryptedClientKey);return new Uint8Array(a)},p=async({challenge:t,clientKey:e})=>{const n=Math.floor(Math.random()*100),a={challenge:s(o(t)),rp:{id:"localhost",name:"notes"},user:{id:new Uint8Array([...e,...crypto.getRandomValues(new Uint8Array(16))]).buffer,name:`account_${n}`,displayName:`account_${n}`},pubKeyCredParams:[{type:"public-key",alg:-7},{type:"public-key",alg:-257}],authenticatorSelection:{userVerification:"required"},timeout:6e4,attestation:"none"},r=await navigator.credentials.create({publicKey:a});if(r){const c=r.response;return{challenge:t,id:r.id,rawId:i(r.rawId),type:r.type,response:{clientDataJSON:i(c.clientDataJSON),attestationObject:i(c.attestationObject)}}}else throw new Error},w=async({challenge:t})=>{const e={challenge:s(o(t)),timeout:6e4,rpId:"localhost",userVerification:"required"},n=await navigator.credentials.get({publicKey:e});if(n){const a=n.response,r={challenge:t,id:n.id,rawId:i(n.rawId),type:n.type,response:{authenticatorData:i(a.authenticatorData),clientDataJSON:i(a.clientDataJSON),signature:i(a.signature)}};if(!a.userHandle)throw new Error("No credential found");const c=new Uint8Array(a.userHandle).slice(0,32);return{credentialData:r,clientKey:c}}else throw new Error("No credential found")};export{i as a,y as b,p as c,u as d,d as e,w as g};
